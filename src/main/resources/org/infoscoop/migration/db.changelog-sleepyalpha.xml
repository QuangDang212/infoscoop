<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd
    http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

	<property name="clob.type" value="clob" dbms="oracle, db2"/>
    <property name="clob.type" value="text" dbms="mysql"/>

    <!--Issue 597-->
    <!--
    ALTER TABLE IS_WIDGETS ROW_FORMAT=DYNAMIC;
    ALTER TABLE IS_LOGS ROW_FORMAT=DYNAMIC;
    ALTER TABLE IS_KEYWORDS ROW_FORMAT=DYNAMIC;
    ALTER TABLE IS_SESSIONS ROW_FORMAT=DYNAMIC;
    ALTER TABLE IS_AUTHCREDENTIALS ROW_FORMAT=DYNAMIC;
    -->
    <changeSet id="infoscoop_sleepyalpha_597_1" author="mikami">
        <preConditions onFail="MARK_RAN" onFailMessage="skip infoscoop_sleepyalpha_597_1">
            <dbms type="mysql"/>
        </preConditions>
        <sql>ALTER TABLE IS_WIDGETS ROW_FORMAT=DYNAMIC;</sql>
        <sql>ALTER TABLE IS_LOGS ROW_FORMAT=DYNAMIC;</sql>
        <sql>ALTER TABLE IS_KEYWORDS ROW_FORMAT=DYNAMIC;</sql>
        <sql>ALTER TABLE IS_SESSIONS ROW_FORMAT=DYNAMIC;</sql>
        <sql>ALTER TABLE IS_AUTHCREDENTIALS ROW_FORMAT=DYNAMIC;</sql>
    </changeSet>

    <!--ALTER TABLE IS_USERPREFS DROP INDEX is_userprefs_value;-->
    <changeSet id="infoscoop_sleepyalpha_597_2" author="mikami">
        <preConditions onFail="MARK_RAN" onFailMessage="skip infoscoop_sleepyalpha_597_2">
            <dbms type="mysql"/>
            <indexExists indexName="is_userprefs_value"/>
        </preConditions>
        <dropIndex indexName="is_userprefs_value" tableName="IS_USERPREFS"/>
    </changeSet>
    
    <!--Issue 598-->
    <!--CREATE TABLE `is_squares` (id varchar(64) not null, name varchar(256) not null, tabdesc text, lastmodified timestamp not null primary key(id));-->
    <!--INSERT INTO `is_squares` VALUES ("default","default","infoScoop Default Square.");-->
    <changeSet id="infoscoop_sleepyalpha_598_2" author="nishiumi">
        <preConditions onFail="HALT" onFailMessage="skip infoscoop_sleepyalpha_598_2">
            <not>
                <tableExists schemaName="${migration.defaultSchema}" tableName="is_squares"/>
            </not>
        </preConditions>
        <createTable tableName="is_squares" tablespace="${.tablespace}">
            <column name="id" type="varchar(64)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(256)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="${clob.type}"/>
            <column name="templastmodified" type="Timestamp">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <insert tableName="is_squares">
            <column name="id" value="default"/>
            <column name="name" value="default"/>
            <column name="description" value="infoScoop Default Square."/>
        </insert>
    </changeSet>
    
    <!--ALTER TABLE IS_* ADD COLUMN square_id varchar(64);-->
    <changeSet id="infoscoop_sleepyalpha_598_3" author="mikami">
        <preConditions onFail="MARK_RAN" onFailMessage="skip infoscoop_sleepyalpha_598_3">
            <not>
                <columnExists schemaName="${migration.defaultSchema}" tableName="IS_ACCESSLOGS" columnName="square_id"/>
            </not>
        </preConditions>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_ACCESSLOGS">
            <column name="square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_ADMINROLES">
            <column name="square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_AUTHCREDENTIALS">
            <column name="square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_CACHES">
            <column name="square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_FORBIDDENURLS">
            <column name="square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_GADGETS">
            <column name="square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_GADGET_ICONS">
            <column name="square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_HOLIDAYS">
            <column name="square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_I18N">
            <column name="square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_I18NLASTMODIFIED">
            <column name="square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_I18NLOCALES">
            <column name="square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_KEYWORDS">
            <column name="square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_LOGS">
            <column name="square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_MENUCACHES">
            <column name="square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_MENUS">
            <column name="square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_MENUS_TEMP">
            <column name="square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_MESSAGES">
            <column name="square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_OAUTHPROVIDER_ACCESSTOKENS">
            <column name="square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_OAUTHPROVIDER_CLIENT">
            <column name="square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_OAUTHPROVIDER_REFRESHTOKENS">
            <column name="square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_OAUTH_GADGET_URLS">
            <column name="square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_OAUTH_CERTIFICATE">
            <column name="square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_OAUTH_CONSUMERS">
            <column name="square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_PORTALADMINS">
            <column name="square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_PORTALLAYOUTS">
            <column name="square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_PREFERENCES">
            <column name="square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_PROPERTIES">
            <column name="square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_PROXYCONFS">
            <column name="square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_RSSCACHES">
            <column name="square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_SEARCHENGINES">
            <column name="square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_SESSIONS">
            <column name="square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_STATIC_TABS">
            <column name="square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_SYSTEMMESSAGES">
            <column name="square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_TABLAYOUTS">
            <column name="square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_TABS">
            <column name="square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_TAB_ADMINS">
            <column name="square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_WIDGETCONFS">
            <column name="square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_WIDGETS">
            <column name="square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <!--ALTER TABLE IS_* ADD FOREIGN KEY;-->
    <changeSet id="infoscoop_sleepyalpha_598_4" author="mikami">
        <preConditions onFail="MARK_RAN" onFailMessage="skip infoscoop_sleepyalpha_598_4">
            <not>
                <foreignKeyConstraintExists schemaName="${migration.defaultSchema}" foreignKeyName="fk_is_accesslogs_square_id"/>
            </not>
        </preConditions>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_ACCESSLOGS" constraintName="fk_is_accesslogs_square_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="is_squares"/>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_ADMINROLES" constraintName="fk_is_adminroles_square_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="is_squares"/>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_AUTHCREDENTIALS" constraintName="fk_is_authcredentials_square_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="is_squares"/>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_CACHES" constraintName="fk_is_caches_square_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="is_squares"/>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_FORBIDDENURLS" constraintName="fk_is_forbiddenurls_square_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="is_squares"/>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_GADGETS" constraintName="fk_is_gadgets_square_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="is_squares"/>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_GADGET_ICONS" constraintName="fk_is_gadgeticons_square_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="is_squares"/>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_HOLIDAYS" constraintName="fk_is_holiday_square_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="is_squares"/>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_I18N" constraintName="fk_is_i18n_square_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="is_squares"/>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_I18NLASTMODIFIED" constraintName="fk_is_i18nlastmodified_square_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="is_squares"/>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_I18NLOCALES" constraintName="fk_is_i18nlocales_square_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="is_squares"/>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_KEYWORDS" constraintName="fk_is_keywords_square_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="is_squares"/>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_LOGS" constraintName="fk_is_logs_square_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="is_squares"/>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_MENUCACHES" constraintName="fk_is_menucaches_square_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="is_squares"/>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_MENUS" constraintName="fk_is_menus_square_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="is_squares"/>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_MENUS_TEMP" constraintName="fk_is_menutemp_square_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="is_squares"/>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_MESSAGES" constraintName="fk_is_messages_square_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="is_squares"/>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_OAUTHPROVIDER_ACCESSTOKENS" constraintName="fk_is_opaccesstokens_square_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="is_squares"/>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_OAUTHPROVIDER_CLIENT" constraintName="fk_is_opclients_square_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="is_squares"/>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_OAUTHPROVIDER_REFRESHTOKENS" constraintName="fk_is_oprefreshtokens_square_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="is_squares"/>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_OAUTH_CERTIFICATE" constraintName="fk_is_oauthcertificate_square_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="is_squares"/>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_OAUTH_CONSUMERS" constraintName="fk_is_oauthconsumers_square_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="is_squares"/>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_PORTALLAYOUTS" constraintName="fk_is_portallayouts_square_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="is_squares"/>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_PREFERENCES" constraintName="fk_is_preferences_square_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="is_squares"/>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_PROPERTIES" constraintName="fk_is_properties_square_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="is_squares"/>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_PROXYCONFS" constraintName="fk_is_proxyconf_square_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="is_squares"/>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_RSSCACHES" constraintName="fk_is_rsscaches_square_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="is_squares"/>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_SEARCHENGINES" constraintName="fk_is_searchengines_square_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="is_squares"/>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_SESSIONS" constraintName="fk_is_sessions_square_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="is_squares"/>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_STATIC_TABS" constraintName="fk_is_statictabs_square_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="is_squares"/>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_SYSTEMMESSAGES" constraintName="fk_is_systemmessages_square_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="is_squares"/>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_TABLAYOUTS" constraintName="fk_is_tablayouts_square_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="is_squares"/>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_TABS" constraintName="fk_is_tabs_square_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="is_squares"/>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_TAB_ADMINS" constraintName="fk_is_tabadmins_square_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="is_squares"/>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_WIDGETCONFS" constraintName="fk_is_widgetconfs_square_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="is_squares"/>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_WIDGETS" constraintName="fk_is_widgets_square_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="is_squares"/>
    </changeSet>

    <!--ALTER TABLE IS_ACCOUNTS ADD COLUMN default_belong_id varchar(64);-->
    <!--ALTER TABLE IS_ACCOUNTS ADD COLUMN belong_id text;-->
    <changeSet id="infoscoop_sleepyalpha_598_5" author="mikami">
        <preConditions onFail="MARK_RAN" onFailMessage="skip infoscoop_sleepyalpha_598_5">
            <not>
                <columnExists schemaName="${migration.defaultSchema}" tableName="IS_ACCOUNTS" columnName="default_belong_id"/>
                <columnExists schemaName="${migration.defaultSchema}" tableName="IS_ACCOUNTS" columnName="belong_id"/>
            </not>
        </preConditions>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_ACCOUNTS">
            <column name="default_belong_id" type="varchar(64)"/>
            <column name="belong_id" type="${clob.type}"/>
        </addColumn>
    </changeSet>

    <!--CREATE INDEX is_*_square_id on IS_*(square_id);-->
    <changeSet id="infoscoop_sleepyalpha_598_6" author="mikami">
        <preConditions onFail="MARK_RAN" onFailMessage="skip infoscoop_sleepyalpha_598_6">
            <not>
                <indexExists indexName="is_accesslogs_square_id"/>
            </not>
        </preConditions>
        <createIndex indexName="is_accesslogs_square_id" schemaName="${migration.defaultSchema}" tableName="IS_ACCESSLOGS" tablespace="${.tablespace}">
            <column name="square_id" type="varchar(64)"/>
        </createIndex>
        <createIndex indexName="is_adminroles_square_id" schemaName="${migration.defaultSchema}" tableName="IS_ADMINROLES" tablespace="${.tablespace}">
            <column name="square_id" type="varchar(64)"/>
        </createIndex>
        <createIndex indexName="is_authcredentials_square_id" schemaName="${migration.defaultSchema}" tableName="IS_AUTHCREDENTIALS" tablespace="${.tablespace}">
            <column name="square_id" type="varchar(64)"/>
        </createIndex>
        <createIndex indexName="is_forbiddenurls_square_id" schemaName="${migration.defaultSchema}" tableName="IS_FORBIDDENURLS" tablespace="${.tablespace}">
            <column name="square_id" type="varchar(64)"/>
        </createIndex>
        <createIndex indexName="is_gadgets_square_id" schemaName="${migration.defaultSchema}" tableName="IS_GADGETS" tablespace="${.tablespace}">
            <column name="square_id" type="varchar(64)"/>
        </createIndex>
        <createIndex indexName="is_i18nlocales_square_id" schemaName="${migration.defaultSchema}" tableName="IS_I18NLOCALES" tablespace="${.tablespace}">
            <column name="square_id" type="varchar(64)"/>
        </createIndex>
        <createIndex indexName="is_keywords_square_id" schemaName="${migration.defaultSchema}" tableName="IS_KEYWORDS" tablespace="${.tablespace}">
            <column name="square_id" type="varchar(64)"/>
        </createIndex>
        <createIndex indexName="is_logs_square_id" schemaName="${migration.defaultSchema}" tableName="IS_LOGS" tablespace="${.tablespace}">
            <column name="square_id" type="varchar(64)"/>
        </createIndex>
        <createIndex indexName="is_messages_square_id" schemaName="${migration.defaultSchema}" tableName="IS_MESSAGES" tablespace="${.tablespace}">
            <column name="square_id" type="varchar(64)"/>
        </createIndex>
        <createIndex indexName="is_portaladmins_square_id" schemaName="${migration.defaultSchema}" tableName="IS_PORTALADMINS" tablespace="${.tablespace}">
            <column name="square_id" type="varchar(64)"/>
        </createIndex>
        <createIndex indexName="is_systemmessages_square_id" schemaName="${migration.defaultSchema}" tableName="IS_SYSTEMMESSAGES" tablespace="${.tablespace}">
            <column name="square_id" type="varchar(64)"/>
        </createIndex>
        <createIndex indexName="is_widgets_square_id" schemaName="${migration.defaultSchema}" tableName="IS_WIDGETS" tablespace="${.tablespace}">
            <column name="square_id" type="varchar(64)"/>
        </createIndex>
    </changeSet>

    <!-- ALTER TABLE IS_* DROP PRIMARY KEY; -->
    <!-- ALTER TABLE IS_* ADD PRIMARY KEY -->
    <changeSet id="infoscoop_sleepyalpha_598_7" author="mikami">
        <preConditions onFail="MARK_RAN" onFailMessage="skip infoscoop_sleepyalpha_598_7">
            <columnExists schemaName="${migration.defaultSchema}" tableName="IS_CACHES" columnName="square_id"/>
        </preConditions>
        <dropAllForeignKeyConstraints baseTableName="IS_OAUTH_GADGET_URLS"/>
        <dropAllForeignKeyConstraints baseTableName="IS_OAUTH_TOKENS"/>
        <dropAllForeignKeyConstraints baseTableName="IS_OAUTH2_TOKENS"/>
        <dropForeignKeyConstraint constraintName="tabid" baseTableName="IS_TAB_ADMINS"/>
        <dropPrimaryKey constraintName="PRIMARY" tableName="IS_CACHES"/>
        <dropPrimaryKey constraintName="PRIMARY" tableName="IS_GADGET_ICONS"/>
        <dropPrimaryKey constraintName="PRIMARY" tableName="IS_HOLIDAYS"/>
        <dropPrimaryKey constraintName="PRIMARY" tableName="IS_I18N"/>
        <dropPrimaryKey constraintName="PRIMARY" tableName="IS_I18NLASTMODIFIED"/>
        <dropPrimaryKey constraintName="PRIMARY" tableName="IS_MENUCACHES"/>
        <dropPrimaryKey constraintName="PRIMARY" tableName="IS_MENUS"/>
        <dropPrimaryKey constraintName="PRIMARY" tableName="IS_MENUS_TEMP"/>
        <dropPrimaryKey constraintName="PRIMARY" tableName="IS_OAUTHPROVIDER_ACCESSTOKENS"/>
        <dropPrimaryKey constraintName="PRIMARY" tableName="IS_OAUTHPROVIDER_CLIENT"/>
        <dropPrimaryKey constraintName="PRIMARY" tableName="IS_OAUTHPROVIDER_REFRESHTOKENS"/>
        <dropPrimaryKey constraintName="PRIMARY" tableName="IS_OAUTH_CERTIFICATE"/>
        <dropPrimaryKey constraintName="PRIMARY" tableName="IS_OAUTH_CONSUMERS"/>
        <dropPrimaryKey constraintName="PRIMARY" tableName="IS_PORTALLAYOUTS"/>
        <dropPrimaryKey constraintName="PRIMARY" tableName="IS_PREFERENCES"/>
        <dropPrimaryKey constraintName="PRIMARY" tableName="IS_PROPERTIES"/>
        <dropPrimaryKey constraintName="PRIMARY" tableName="IS_RSSCACHES"/>
        <dropPrimaryKey constraintName="PRIMARY" tableName="IS_SESSIONS"/>
        <dropPrimaryKey constraintName="PRIMARY" tableName="IS_STATIC_TABS"/>
        <dropPrimaryKey constraintName="PRIMARY" tableName="IS_TABLAYOUTS"/>
        <dropPrimaryKey constraintName="PRIMARY" tableName="IS_TABS"/>
        <dropPrimaryKey constraintName="PRIMARY" tableName="IS_TAB_ADMINS"/>
        <dropPrimaryKey constraintName="PRIMARY" tableName="IS_WIDGETCONFS"/>
        <addPrimaryKey schemaName="${migration.defaultSchema}" columnNames="id, square_id" constraintName="PRIMARY" tableName="IS_CACHES"/>
        <addPrimaryKey schemaName="${migration.defaultSchema}" columnNames="type, square_id" constraintName="PRIMARY" tableName="IS_GADGET_ICONS"/>
        <addPrimaryKey schemaName="${migration.defaultSchema}" columnNames="country, lang, square_id" constraintName="PRIMARY" tableName="IS_HOLIDAYS"/>
        <addPrimaryKey schemaName="${migration.defaultSchema}" columnNames="type, id, country, lang, square_id" constraintName="PRIMARY" tableName="IS_I18N"/>
        <addPrimaryKey schemaName="${migration.defaultSchema}" columnNames="type, square_id" constraintName="PRIMARY" tableName="IS_I18NLASTMODIFIED"/>
        <addPrimaryKey schemaName="${migration.defaultSchema}" columnNames="UID, url_key, square_id" constraintName="PRIMARY" tableName="IS_MENUCACHES"/>
        <addPrimaryKey schemaName="${migration.defaultSchema}" columnNames="type, square_id" constraintName="PRIMARY" tableName="IS_MENUS"/>
        <addPrimaryKey schemaName="${migration.defaultSchema}" columnNames="type, siteTopId, square_id" constraintName="PRIMARY" tableName="IS_MENUS_TEMP"/>
        <addPrimaryKey schemaName="${migration.defaultSchema}" columnNames="id, square_id" constraintName="PRIMARY" tableName="IS_OAUTHPROVIDER_ACCESSTOKENS"/>
        <addPrimaryKey schemaName="${migration.defaultSchema}" columnNames="id, square_id" constraintName="PRIMARY" tableName="IS_OAUTHPROVIDER_CLIENT"/>
        <addPrimaryKey schemaName="${migration.defaultSchema}" columnNames="id, square_id" constraintName="PRIMARY" tableName="IS_OAUTHPROVIDER_REFRESHTOKENS"/>
        <addPrimaryKey schemaName="${migration.defaultSchema}" columnNames="consumer_key, square_id" constraintName="PRIMARY" tableName="IS_OAUTH_CERTIFICATE"/>
        <addPrimaryKey schemaName="${migration.defaultSchema}" columnNames="id, square_id" constraintName="PRIMARY" tableName="IS_OAUTH_CONSUMERS"/>
        <addPrimaryKey schemaName="${migration.defaultSchema}" columnNames="name, square_id" constraintName="PRIMARY" tableName="IS_PORTALLAYOUTS"/>
        <addPrimaryKey schemaName="${migration.defaultSchema}" columnNames="UID, square_id" constraintName="PRIMARY" tableName="IS_PREFERENCES"/>
        <addPrimaryKey schemaName="${migration.defaultSchema}" columnNames="id, square_id" constraintName="PRIMARY" tableName="IS_PROPERTIES"/>
        <addPrimaryKey schemaName="${migration.defaultSchema}" columnNames="temp, square_id" constraintName="PRIMARY" tableName="IS_PROXYCONFS"/>
        <addPrimaryKey schemaName="${migration.defaultSchema}" columnNames="UID, url_key, pageNum, square_id" constraintName="PRIMARY" tableName="IS_RSSCACHES"/>
        <addPrimaryKey schemaName="${migration.defaultSchema}" columnNames="temp, square_id" constraintName="PRIMARY" tableName="IS_SEARCHENGINES"/>
        <addPrimaryKey schemaName="${migration.defaultSchema}" columnNames="UID, square_id" constraintName="PRIMARY" tableName="IS_SESSIONS"/>
        <addPrimaryKey schemaName="${migration.defaultSchema}" columnNames="tabid, adminUid, square_id" constraintName="PRIMARY" tableName="IS_TAB_ADMINS"/>
        <addPrimaryKey schemaName="${migration.defaultSchema}" columnNames="tabid, square_id" constraintName="PRIMARY" tableName="IS_STATIC_TABS"/>
        <addPrimaryKey schemaName="${migration.defaultSchema}" columnNames="tabId, roleOrder, temp, square_id" constraintName="PRIMARY" tableName="IS_TABLAYOUTS"/>
        <addPrimaryKey schemaName="${migration.defaultSchema}" columnNames="UID, id, square_id" constraintName="PRIMARY" tableName="IS_TABS"/>
        <addPrimaryKey schemaName="${migration.defaultSchema}" columnNames="type, square_id" constraintName="PRIMARY" tableName="IS_WIDGETCONFS"/>
    </changeSet>

    <!-- ALTER TABLE address ADD IS_* * FOREIGN KEY (*) REFERENCES IS_*(*) ON DELETE CASCADE; -->
    <changeSet id="infoscoop_sleepyalpha_598_8" author="mikami">
        <preConditions onFail="MARK_RAN" onFailMessage="skip infoscoop_sleepyalpha_598_8">
            <not>
                <foreignKeyConstraintExists schemaName="${migration.defaultSchema}" foreignKeyName="tabid"/>
            </not>
        </preConditions>
        <createIndex indexName="is_static_tabs_tabid_square_id" schemaName="${migration.defaultSchema}" tableName="IS_STATIC_TABS" tablespace="${.tablespace}">
            <column name="tabid" type="varchar(64)"/>
            <column name="square_id" type="varchar(64)"/>
        </createIndex>
        <addForeignKeyConstraint baseColumnNames="fk_oauth_id" baseTableName="IS_OAUTH_GADGET_URLS" constraintName="fk_is_oauth_gadget_urls_fk_oid" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="IS_OAUTH_CONSUMERS"/>
        <addForeignKeyConstraint baseColumnNames="fk_oauth_id" baseTableName="IS_OAUTH_TOKENS" constraintName="fk_is_oauth_fk_oid" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="IS_OAUTH_CONSUMERS"/>
        <addForeignKeyConstraint baseColumnNames="fk_oauth_id" baseTableName="IS_OAUTH2_TOKENS" constraintName="fk_is_oauth2_fk_oid" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="IS_OAUTH_CONSUMERS"/>
        <addForeignKeyConstraint baseColumnNames="tabid, square_id" baseTableName="IS_TAB_ADMINS" constraintName="tabid" onDelete="CASCADE" referencedColumnNames="tabid, square_id" referencedTableName="IS_STATIC_TABS"/>
    </changeSet>

    <!-- target is_oauth_gadget_urls. 他のカラム都合によりここにしかいれられない -->
    <changeSet id="infoscoop_sleepyalpha_598_9" author="mikami">
        <preConditions onFail="MARK_RAN" onFailMessage="skip infoscoop_sleepyalpha_598_9">
            <not>
                <foreignKeyConstraintExists schemaName="${migration.defaultSchema}" foreignKeyName="fk_is_oauthgadgeturls_square_id"/>
            </not>
        </preConditions>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_OAUTH_GADGET_URLS" constraintName="fk_is_oauthgadgeturls_square_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="is_squares"/>
        <createIndex indexName="is_oauthgadgeturls_square_id" schemaName="${migration.defaultSchema}" tableName="IS_OAUTH_GADGET_URLS" tablespace="${.tablespace}">
            <column name="square_id" type="varchar(64)"/>
        </createIndex>
    </changeSet>

    <!-- ALTER TABLE IS_* DROP KEY *; -->
    <!-- ALTER TABLE IS_* ADD CONSTRAINT * UNIQUE (*, square_id); -->
    <changeSet id="infoscoop_sleepyalpha_598_10" author="mikami">
        <preConditions onFail="MARK_RAN" onFailMessage="skip infoscoop_sleepyalpha_598_10">
            <columnExists schemaName="${migration.defaultSchema}" tableName="IS_WIDGETS" columnName="square_id"/>
        </preConditions>
        <dropUniqueConstraint constraintName="is_widgets_unique" schemaName="${migration.defaultSchema}" tableName="IS_WIDGETS"/>
        <dropUniqueConstraint constraintName="is_gadgets_uq" schemaName="${migration.defaultSchema}" tableName="IS_GADGETS"/>
        <dropUniqueConstraint constraintName="is_locales_unique" schemaName="${migration.defaultSchema}" tableName="IS_I18NLOCALES"/>
        <dropUniqueConstraint constraintName="is_portaladmins_uq" schemaName="${migration.defaultSchema}" tableName="IS_PORTALADMINS"/>
        <dropUniqueConstraint constraintName="is_accesslogs_uq" schemaName="${migration.defaultSchema}" tableName="IS_ACCESSLOGS"/>
        <addUniqueConstraint columnNames="UID, tabid, widgetId, deleteDate, square_id" constraintName="is_widgets_unique" schemaName="${migration.defaultSchema}" tableName="IS_WIDGETS" tablespace="${.tablespace}"/>
        <addUniqueConstraint columnNames="type, path, name, square_id" constraintName="is_gadgets_uq" schemaName="${migration.defaultSchema}" tableName="IS_GADGETS" tablespace="${.tablespace}"/>
        <addUniqueConstraint columnNames="type, country, lang, square_id" constraintName="is_locales_unique" schemaName="${migration.defaultSchema}" tableName="IS_I18NLOCALES" tablespace="${.tablespace}"/>
        <addUniqueConstraint columnNames="UID, square_id" constraintName="is_portaladmins_uq" schemaName="${migration.defaultSchema}" tableName="IS_PORTALADMINS" tablespace="${.tablespace}"/>
        <addUniqueConstraint columnNames="UID, DATE, square_id" constraintName="is_accesslogs_uq" schemaName="${migration.defaultSchema}" tableName="IS_ACCESSLOGS" tablespace="${.tablespace}"/>
    </changeSet>

    <!-- ALTER TABLE IS_PORTALADMINS DROP KEY *; -->
    <!-- ALTER TABLE .IS_PORTALADMINS DROP COLUMN roleid; -->
    <!-- ALTER TABLE address ADD CONSTRAINT fk_address_person FOREIGN KEY (person_id) REFERENCES person (id) ON UPDATE RESTRICT ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED; -->
    <changeSet id="infoscoop_sleepyalpha_598_11" author="mikami">
        <preConditions onFail="MARK_RAN" onFailMessage="skip infoscoop_sleepyalpha_598_11">
            <columnExists schemaName="${migration.defaultSchema}" tableName="IS_ADMINROLES" columnName="roleid"/>
        </preConditions>
        <dropAllForeignKeyConstraints baseTableName="IS_PORTALADMINS"/>
        <dropColumn schemaName="${migration.defaultSchema}" tableName="IS_ADMINROLES" columnName="roleid" />
        <modifyDataType columnName="ROLEID" newDataType="bigint" schemaName="${migration.defaultSchema}" tableName="IS_PORTALADMINS"/>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_PORTALADMINS" constraintName="fk_is_portaladmins_square_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="is_squares"/>
        <addForeignKeyConstraint baseColumnNames="ROLEID" baseTableName="IS_PORTALADMINS" constraintName="fk_is_portaladmins_roleid" onDelete="SET NULL" referencedColumnNames="id" referencedTableName="IS_ADMINROLES"/>
    </changeSet>
</databaseChangeLog>